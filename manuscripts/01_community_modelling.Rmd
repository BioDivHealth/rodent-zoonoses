---
title: "Modelling Zoonoses in Rodent Communities"
author: "David Redding, Greg Milne, Ana Martinez-Checa, Harry Gordon"
date: "07/06/2024"
output: pdf_document
bibliography: 01_references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This is the working manuscript for a study on disease modelling in rodent communities by the Infectious Disease Systems Ecology group at the British Natural History Museum.

David Simons' paper: @simons2023.

Paper on causal inference: @dee2023.

## Methods

These are the methods.

Here is a world map displaying locations of our sampled rodents:

```{r plot_world_map, echo=FALSE}
# Load necessary libraries
library(ggplot2)
library(maps)
library(mapdata)

# Load data frame
host_path <- readRDS("../data/host_path_wide.rds")
attach(host_path)
# Get the world map data
world <- map_data("world")

# Plot the points onto the world map 
ggplot() +
  geom_polygon(data = world, aes(x = long, y = lat, group = group), fill = "lightgray", color = "darkgray") +
  geom_point(data = host_path, aes(x = decimalLongitude, y = decimalLatitude), color = "red", size = 2) +
  theme_minimal() +
  coord_fixed(1.3) +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank())

```

Here is a timeline of the samples used in this analysis:

```{r plot_timeline, echo=FALSE, fig.height = 2}
# Load necessary libraries
library(ggplot2)

# plot the study dates on a timeline
ggplot(host_path, aes(x = start_date, y = 1)) +
  geom_segment(aes(x = start_date, xend = start_date, y = 0.9, yend = 1.1), color = "red") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_y_continuous(limits = c(0.5, 1.5)) +
  labs(title = "Timeline of Samples", x = "Date", y = "") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

```
Here is the infectivity rates of our sampled rodents:

```{r plot_infection, echo=FALSE, message=FALSE, warning=FALSE, fig.width=40, fig.height=25}
pacman::p_load(here,
               stringr,
               dplyr,
               ggplot2,
               tidyr)
host.pathogen.data <- readRDS(here("data", "host_path_wide.rds"))


# Correct species names
mutated.host.pathogen.data <- host.pathogen.data %>%
  mutate(associatedTaxa = case_when(
    associatedTaxa == "Akodon azare" ~ "Akodon azarae",
    associatedTaxa == "brush mice" ~ "Peromyscus boylii",
    associatedTaxa == "Clethrionomys glareolus" ~ "Myodes glareolus",
    associatedTaxa == "Clethryonomys glareolus" ~ "Myodes glareolus",
    associatedTaxa == "Oligoryzomys favescens" ~ "Oligoryzomys flavescens",
    associatedTaxa == "P. californicus" ~ "Peromyscus californicus",
    associatedTaxa == "dusky-footed" ~ "Neotoma fuscipes",
    TRUE ~ associatedTaxa  # Retain original name if no match
  ))

# Ensure 'positive' and 'negative' are numeric
plot.positives.negatives <- mutated.host.pathogen.data %>%
mutate(positive = as.numeric(positive),
       negative = as.numeric(negative))

# Aggregate the data by associatedTaxa
plot_aggregated <- plot.positives.negatives %>%
  group_by(associatedTaxa) %>%
  summarize(
    positives = sum(positive),
    negatives = sum(negative)
  ) %>%
  ungroup()

###if 1 big plot not combined
plot.infectivity <- plot_aggregated %>%
  pivot_longer(cols = c("positives", "negatives"), 
               names_to = "Result", 
               values_to = "Count")

ggplot(plot.infectivity, aes(x = associatedTaxa, y = Count, fill = Result)) +
  geom_col(position = "stack", width = 0.7) +
  scale_fill_manual(values = c("positives" = "orange", "negatives" = "olivedrab3")) +
  labs(x = "Associated Taxa", y = "tested", fill = "Test Result") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r plot_infection, echo=FALSE, message=FALSE, warning=FALSE, fig.width=40}
pacman::p_load(here,
               stringr,
               dplyr,
               ggplot2,
               tidyr)
host.pathogen.data <- readRDS(here("data", "host_path_wide.rds"))


# Correct species names
mutated.host.pathogen.data <- host.pathogen.data %>%
  mutate(associatedTaxa = case_when(
    associatedTaxa == "Akodon azare" ~ "Akodon azarae",
    associatedTaxa == "brush mice" ~ "Peromyscus boylii",
    associatedTaxa == "Clethrionomys glareolus" ~ "Myodes glareolus",
    associatedTaxa == "Clethryonomys glareolus" ~ "Myodes glareolus",
    associatedTaxa == "Oligoryzomys favescens" ~ "Oligoryzomys flavescens",
    associatedTaxa == "P. californicus" ~ "Peromyscus californicus",
    associatedTaxa == "dusky-footed" ~ "Neotoma fuscipes",
    TRUE ~ associatedTaxa  # Retain original name if no match
  ))

# Ensure 'positive' and 'negative' are numeric
plot.positives.negatives <- mutated.host.pathogen.data %>%
  mutate(positive = as.numeric(positive),
         negative = as.numeric(negative),
         individualCount = as.numeric(individualCount))

# Aggregate the data by associatedTaxa
plot_aggregated <- plot.positives.negatives %>%
  group_by(associatedTaxa) %>%
  summarize(
    positives = sum(positive, na.rm = TRUE),
    negatives = sum(negative, na.rm = TRUE),
    abundance = sum(individualCount, na.rm = TRUE),
  ) %>%
  ungroup()

# Calculate the % of positives
aggregated_data1 <- plot_aggregated %>%
  mutate(percent_positive = ifelse((positives + negatives) == 0, NA, 
                                   (positives / (positives + negatives)) * 100))

# Remove rows with NA values for % positive
aggregated_data2 <- aggregated_data1 %>%
  filter(!is.na(percent_positive))

# Sort data by abundance from less to more
aggregated_data3 <- aggregated_data2 %>%
  arrange(abundance)

# Plot scatter graph
ggplot(aggregated_data3, aes(x = abundance, y = percent_positive, label = associatedTaxa, color = associatedTaxa)) +
  geom_point() +
  geom_text(size = 2, vjust = -1, hjust = 0.5) +  # Adjust text size
  labs(
    title = "Abundance vs % of Positives",
    x = "Abundance",
    y = "% of Positives"
  ) +
  theme_minimal()

```

### Rodent phylogeny

Here is the mammal tree with our host species higlighted

```{r plot_phylogeny, echo=FALSE, message=FALSE, warning=FALSE}
# load necessary libraries
library(ggtree)
library(ggplot2)
library(here)

# load data
host.clade <- read.tree(here("data", "./phylogenetics/host.mrca.tree"))
pruned.host.spp <- readRDS(here("data", "./phylogenetics/harmonised.host.sp.names.rds")) %>%
  as.data.frame()

# find our species of interest
host.clade$in.data <- ifelse(host.clade$tip.label %in% pruned.host.spp$tree.names, 
       "purple", NA)
host.clade$in.data <- as.factor(host.clade$in.data)

# Plot the phylogeny
ggtree(host.clade, size = 0.05) + 
  geom_tippoint(color = host.clade$in.data, size = 3) + 
  geom_treescale(x = 0, y = 2200, col = "midnightblue")

```

### GLC database

Here is an example of a raster from the GLC database, the X and Y are Longitude and Latitude respectively.

```{r plot_raster, echo=FALSE, message=FALSE, warning=FALSE}
# Load necessary libraries
library(raster)
library(tiff)

str_name <-'../data/example_raster/19852000_E15N45.tif' 
raster_stack <- stack(str_name)

croat_1990 <- raster_stack[[2]]

plot(croat_1990, main="Land cover for Croatia in 1990")
```

## Results

These are the results.

## Discussion

This is the discussion.

## References
